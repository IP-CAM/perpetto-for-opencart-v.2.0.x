<modification>
  <name>Perpetto for Opencart</name>
	<version>1.1</version>
	<link>https://perpetto.com</link>
	<author>iSenseLabs</author>
	<code>perpetto_ocmod</code>

  <file path="catalog/view/theme/*/template/common/footer.tpl">
    <operation>
      <search><![CDATA[</body>]]></search>
      <add position="before">
      <![CDATA[
        <script type="text/javascript">
          window.PERPETTO_ACCOUNT="<?php if(!empty($perpetto_settings['account_id'])) echo $perpetto_settings['account_id']; else echo ''  ?>";
          window.onPerpettoLoaded = function(){
                  Perpetto.update()
          }
        </script>
        <script type="text/javascript" src="https://ptto-srv-cdn.azureedge.net/assets/api/v1/embed.js"></script>
        ]]>
       </add>
    </operation>
  </file>

  <file path="catalog/controller/common/footer.php">
    <operation>
      <search><![CDATA[if (file_exists(DIR_TEMPLATE . $this->config->get('config_template') . '/template/common/footer.tpl')) {]]></search>
      <add position="before">
        <![CDATA[
          $data['perpetto_settings'] =  $this->config->get('perpetto');
        ]]>
      </add>
    </operation>
  </file>

  <file path="catalog/controller/product/product.php">
		<operation>
			<search><![CDATA[if (file_exists(DIR_TEMPLATE . $this->config->get('config_template') . '/template/product/product.tpl')) {]]></search>
      <add position="before">
        <![CDATA[
          $product_categories = $this->model_catalog_product->getCategories($product_id);
          if(!empty($product_categories)) {
            foreach($product_categories as $cat) {
              $cat_info = $this->model_catalog_category->getCategory($cat['category_id']);
              $p_cats[] = htmlspecialchars_decode($cat_info['name']);
            }
          } else {
            $p_cats = array();
          }

          if(!empty($data['tags'])) {
            foreach($data['tags'] as $tag) {
              $p_tags[] = $tag['tag'];
            }
          } else {
            $p_tags = array();
          }

          $p_manufacturer = '';
          if(!empty($manufacturer_info['name'])) {
            $p_manufacturer = $manufacturer_info['name'];
          }

          if ((float)$product_info['special']) {
                      $ptto_special = number_format((float)$this->tax->calculate($product_info['special'], $product_info['tax_class_id'], $this->config->get('config_tax')),2);
                  } else {
                      $ptto_special = '';
                  }

          $data['perpetto'] = array(
            'product_id' => $this->request->get['product_id'],
            'product_name' => $product_info['name'],
            'image'=> $data['popup'],
            'canonical' => htmlspecialchars_decode($this->url->link('product/product', 'product_id=' . $this->request->get['product_id'])),
            'price' => number_format((float)$this->tax->calculate($product_info['price'], $product_info['tax_class_id'], $this->config->get('config_tax')),2),
            'currency' => $this->session->data['currency'],
            'availability' => $product_info['quantity'],
            'categories'=> implode('/',$p_cats),
            'special' => $ptto_special,
            'manufacturer' => $p_manufacturer,
            'tags' => implode(',',$p_tags),
            'summary' => trim(substr(strip_tags($data['description']),0,128))
          );
        ]]>
      </add>
		</operation>
	</file>

  <!-- JOURNAL2 SUPPORT -->
  <file path="catalog/controller/journal2/quickview.php">
    <operation>
      <search><![CDATA[$this->response->setOutput($this->load->view($this->config->get('config_template') . '/template/journal2/quickview/quickview.tpl', $data));]]></search>
      <add position="before">
        <![CDATA[
          $product_categories = $this->model_catalog_product->getCategories($this->request->get['pid']);
          if(!empty($product_categories)) {
            foreach($product_categories as $cat) {
              $cat_info = $this->model_catalog_category->getCategory($cat['category_id']);
              $p_cats[] = htmlspecialchars_decode($cat_info['name']);
            }
          } else {
            $p_cats = array();
          }

          if(!empty($data['tags'])) {
            foreach($data['tags'] as $tag) {
              $p_tags[] = $tag['tag'];
            }
          } else {
            $p_tags = array();
          }

          $p_manufacturer = '';
          if(!empty($manufacturer_info['name'])) {
            $p_manufacturer = $manufacturer_info['name'];
          }

          if ((float)$product_info['special']) {
            $ptto_special = number_format((float)$this->tax->calculate($product_info['special'], $product_info['tax_class_id'], $this->config->get('config_tax')),2);
          } else {
            $ptto_special = '';
          }

          $data['perpetto'] = array(
            'product_id' => $this->request->get['pid'],
            'product_name' => $product_info['name'],
            'image'=> $data['popup'],
            'canonical' => htmlspecialchars_decode($this->url->link('product/product', 'product_id=' . $this->request->get['pid'])),
            'price' => number_format((float)$this->tax->calculate($product_info['price'], $product_info['tax_class_id'], $this->config->get('config_tax')),2),
            'currency' => $this->session->data['currency'],
            'availability' => $product_info['quantity'],
            'categories'=> implode('/',$p_cats),
            'special' => $ptto_special,
            'manufacturer' => $p_manufacturer,
            'tags' => implode(',',$p_tags),
            'summary' => trim(substr(strip_tags($data['description']),0,128))
          );
        ]]>
      </add>
		</operation>
	</file>

  <!-- JOURNAL2 SUPPORT -->
  <file path="catalog/view/theme/journal2/template/journal2/quickview/quickview.tpl">
    <operation>
      <search><![CDATA[</body>]]></search>
      <add position="before">
        <![CDATA[
          <div class="ptto-item-details" style="display:none">
            <!-- required -->
            <div class="ptto-id"><?php echo $perpetto['product_id']; ?></div>
            <div class="ptto-name"><?php echo $perpetto['product_name']; ?></div>
            <img class="ptto-image" src="<?php echo $perpetto['image']; ?>" />
            <div class="ptto-url"><?php echo $perpetto['canonical'] ?></div>
            <div class="ptto-listprice"><?php echo $perpetto['price'] ?></div>
            <div class="ptto-currency"><?php echo $perpetto['currency'] ?></div>
            <div class="ptto-availability"><?php echo ($perpetto['availability']<=0) ? '0' : '1' ; ?></div>
            <div class="ptto-categories"><?php echo $perpetto['categories'] ?></div>
            <div class="ptto-category"><?php echo $perpetto['categories'] ?></div>
             <!-- optional -->
            <div class="ptto-price"><?php echo (!empty($perpetto['special'])) ? $perpetto['special'] : '' ?></div>
            <div class="ptto-brand"><?php echo $perpetto['manufacturer'] ?></div>
            <div class="ptto-tags"><?php echo $perpetto['tags'] ?></div>
            <div class="ptto-summary"><?php echo $perpetto['summary'] ?></div>
          </div>
        ]]>
      </add>
    </operation>
	</file>

  <file path="catalog/view/theme/*/template/product/product.tpl">
		<operation>
			<search><![CDATA[<?php echo $footer; ?>]]></search>
      <add position="before">
        <![CDATA[
				  <div class="ptto-item-details" style="display:none">
            <!-- required -->
            <div class="ptto-id"><?php echo $perpetto['product_id']; ?></div>
            <div class="ptto-name"><?php echo $perpetto['product_name']; ?></div>
            <img class="ptto-image" src="<?php echo $perpetto['image']; ?>" />
            <div class="ptto-url"><?php echo $perpetto['canonical'] ?></div>
            <div class="ptto-listprice"><?php echo $perpetto['price'] ?></div>
            <div class="ptto-currency"><?php echo $perpetto['currency'] ?></div>
            <div class="ptto-availability"><?php echo ($perpetto['availability']<=0) ? '0' : '1' ; ?></div>
            <div class="ptto-categories"><?php echo $perpetto['categories'] ?></div>
            <div class="ptto-category"><?php echo $perpetto['categories'] ?></div>
            <!-- optional -->
            <div class="ptto-price"><?php echo (!empty($perpetto['special'])) ? $perpetto['special'] : '' ?></div>
            <div class="ptto-brand"><?php echo $perpetto['manufacturer'] ?></div>
            <div class="ptto-tags"><?php echo $perpetto['tags'] ?></div>
            <div class="ptto-summary"><?php echo $perpetto['summary'] ?></div>
          </div>
          ]]>
      </add>
		</operation>
    <!-- PAVILLION SUPPORT -->
    <operation>
			<search><![CDATA[<?php $tbData->slotStart('product/product.breadcrumbs'); ?>]]></search>
      <add position="after">
        <![CDATA[
          <div class="ptto-item-details" style="display:none">
            <!-- required -->
            <div class="ptto-id"><?php echo $perpetto['product_id']; ?></div>
            <div class="ptto-name"><?php echo $perpetto['product_name']; ?></div>
            <img class="ptto-image" src="<?php echo $perpetto['image']; ?>" />
            <div class="ptto-url"><?php echo $perpetto['canonical'] ?></div>
            <div class="ptto-listprice"><?php echo $perpetto['price'] ?></div>
            <div class="ptto-currency"><?php echo $perpetto['currency'] ?></div>
            <div class="ptto-availability"><?php echo ($perpetto['availability']<=0) ? '0' : '1' ; ?></div>
            <div class="ptto-categories"><?php echo $perpetto['categories'] ?></div>
            <div class="ptto-category"><?php echo $perpetto['categories'] ?></div>
            <!-- optional -->
            <div class="ptto-price"><?php echo (!empty($perpetto['special'])) ? $perpetto['special'] : '' ?></div>
            <div class="ptto-brand"><?php echo $perpetto['manufacturer'] ?></div>
            <div class="ptto-tags"><?php echo $perpetto['tags'] ?></div>
            <div class="ptto-summary"><?php echo $perpetto['summary'] ?></div>
          </div>
        ]]>
      </add>
		</operation>
	</file>

  <file path="catalog/controller/product/category.php">
		<operation>
			<search><![CDATA[if (file_exists(DIR_TEMPLATE . $this->config->get('config_template') . '/template/product/category.tpl')) {]]></search>
      <add position="before">
        <![CDATA[
          for($i=1;$i<count($data['breadcrumbs']);$i++) {
            $p_cats[] = $data['breadcrumbs'][$i]['text'];
          }

          $data['perpetto'] = array(
            'categories'=> implode('/',$p_cats)
          );
        ]]>
      </add>
		</operation>
	</file>

  <file path="catalog/view/theme/*/template/product/category.tpl">
		<operation>
			<search><![CDATA[<?php echo $footer; ?>]]></search>
      <add position="before">
        <![CDATA[
          <div class="ptto-category" style="display: none"><?php echo $perpetto['categories'] ?></div>
        ]]>
      </add>
		</operation>

    <!-- PAVILLION SUPPORT -->
    <operation>
			<search><![CDATA[<?php $tbData->slotStart('product/category.breadcrumbs'); ?>]]></search>
      <add position="after">
        <![CDATA[
          <div class="ptto-category" style="display: none"><?php echo $perpetto['categories'] ?></div>
        ]]>
      </add>
		</operation>
	</file>

  <file path="system/library/cart.php">
		<operation>
			<search><![CDATA[public function add($product_id, $qty = 1, $option = array(), $recurring_id = 0) {]]></search>
      <add position="after">
        <![CDATA[
          if(empty($this->session->data['cart'])) {
            $this->session->data['perpetto_cart_id'] = base64_encode(time()+':'+$_SERVER['REMOTE_ADDR']);
          }
        ]]>
      </add>
		</operation>
	</file>

  <file path="system/library/cart.php">
		<operation>
			<search><![CDATA[public function add($product_id, $quantity = 1, $option = array(), $recurring_id = 0) {]]></search>
      <add position="after">
        <![CDATA[
          if(empty($this->session->data['cart'])) {
            $this->session->data['perpetto_cart_id'] = base64_encode(time()+':'+$_SERVER['REMOTE_ADDR']);
          }
        ]]>
      </add>
		</operation>
	</file>

  <file path="catalog/controller/checkout/cart.php">
    <operation>
			<search><![CDATA[$data['products'][] = array(]]></search>
      <add position="after">
        <![CDATA[
          'product_id'   => $product['product_id'],
          'original_price' => $this->tax->calculate($product['price'], $product['tax_class_id'], $this->config->get('config_tax')),
        ]]>
      </add>
		</operation>

		<operation>
			<search><![CDATA[if (file_exists(DIR_TEMPLATE . $this->config->get('config_template') . '/template/checkout/cart.tpl')) {]]></search>
      <add position="before">
        <![CDATA[
          if(isset($this->session->data['perpetto_cart_id'])) {
            $data['perpetto']['cart_id'] = $this->session->data['perpetto_cart_id'];
          } else {
            $data['perpetto']['cart_id'] = '';
          }

          if(!empty($total_data)) {
            foreach($total_data as $p_data) {
              if($p_data['code'] == 'total') {
                $data['perpetto']['total'] = $p_data['value'];
              }
            }
          } else {
            $data['perpetto']['total'] = 0;
          }

          $data['perpetto']['currency'] =  $this->session->data['currency'];

          if(empty($data['products']) || count($data['products']) < 1) {
            $data['perpetto']['enabled'] = false;
          } else {
            $data['perpetto']['enabled'] = true;
          }
        ]]>
      </add>
		</operation>
	</file>

  <!-- QUICKCHECKOUT SUPPORT -->
  <file path="catalog/controller/quickcheckout/cart.php">
    <operation>
			<search><![CDATA['key'        => isset($product['key']) ? $product['key'] : $product['cart_id'],]]></search>
      <add position="after">
        <![CDATA[
          'product_id'   => $product['product_id'],
          'original_price' => $this->tax->calculate($product['price'], $product['tax_class_id'], $this->config->get('config_tax')),
        ]]>
      </add>
		</operation>

		<operation>
			<search><![CDATA[if (file_exists(DIR_TEMPLATE . $this->config->get('config_template') . '/template/quickcheckout/cart.tpl')) {]]></search>
      <add position="before">
        <![CDATA[
          if(isset($this->session->data['perpetto_cart_id'])) {
            $data['perpetto']['cart_id'] = $this->session->data['perpetto_cart_id'];
          } else {
            $data['perpetto']['cart_id'] = '';
          }

          if(!empty($total_data)) {
            foreach($total_data as $p_data) {
              if($p_data['code'] == 'total') {
                $data['perpetto']['total'] = $p_data['value'];
              }
            }
          } else {
            $data['perpetto']['total'] = 0;
          }

          $data['perpetto']['currency'] =  $this->session->data['currency'];

          if(empty($data['products']) || count($data['products']) < 1) {
            $data['perpetto']['enabled'] = false;
          } else {
            $data['perpetto']['enabled'] = true;
          }
        ]]>
      </add>
		</operation>
	</file>

  	<!-- AJAXQUICKCHECKOUT SUPPORT -->
  <file path="catalog/controller/d_quickcheckout/cart.php">
    <operation>
			<search><![CDATA['key'       => (isset($product['cart_id'])) ? $product['cart_id'] : $product['key'],]]></search>
      <add position="after">
        <![CDATA[
          'product_id'   => $product['product_id'],
          'original_price' => $this->tax->calculate($product['price'], $product['tax_class_id'], $this->config->get('config_tax')),
        ]]>
      </add>
		</operation>
		<operation>
			<search><![CDATA[if (file_exists(DIR_TEMPLATE . $this->config->get('config_template') . '/template/d_quickcheckout/cart.tpl')) {]]></search>
      <add position="before">
        <![CDATA[
          if(isset($this->session->data['perpetto_cart_id'])) {
            $data['perpetto']['cart_id'] = $this->session->data['perpetto_cart_id'];
          } else {
            $data['perpetto']['cart_id'] = '';
          }

          if(!empty($total_data)) {
            foreach($total_data as $p_data) {
              if($p_data['code'] == 'total') {
                $data['perpetto']['total'] = $p_data['value'];
              }
            }
          } else {
            $data['perpetto']['total'] = 0;
          }

          $data['perpetto']['currency'] =  $this->session->data['currency'];

          if(empty($data['products']) || count($data['products']) < 1) {
            $data['perpetto']['enabled'] = false;
          } else {
            $data['perpetto']['enabled'] = true;
          }
        ]]>
      </add>
		</operation>
	</file>

  <!-- SIMPLECHECKOUT SUPPORT -->
  <file path="catalog/controller/checkout/simplecheckout_cart.php">
    <operation>
      <search><![CDATA['key'      => $product['key'],]]></search>
      <add position="after">
        <![CDATA[
          'product_id'   => $product['product_id'],
          'original_price' => $this->tax->calculate($product['price'], $product['tax_class_id'], $this->config->get('config_tax')),
        ]]>
      </add>
    </operation>
    <operation>
      <search><![CDATA[$this->setOutputContent($this->renderPage('checkout/simplecheckout_cart.tpl', $this->_templateData));]]></search>
      <add position="before">
        <![CDATA[
          if(isset($this->session->data['perpetto_cart_id'])) {
            $data['perpetto']['cart_id'] = $this->session->data['perpetto_cart_id'];
          } else {
            $data['perpetto']['cart_id'] = '';
          }

          if(!empty($total_data)) {
            foreach($total_data as $p_data) {
              if($p_data['code'] == 'total') {
                $data['perpetto']['total'] = $p_data['value'];
              }
            }
          } else {
            $data['perpetto']['total'] = 0;
          }

          $data['perpetto']['currency'] =  $this->session->data['currency'];

          if(empty($data['products']) || count($data['products']) < 1) {
            $data['perpetto']['enabled'] = false;
          } else {
            $data['perpetto']['enabled'] = true;
          }
        ]]>
      </add>
		</operation>
	</file>

  <file path="catalog/view/theme/*/template/checkout/cart.tpl">
		<operation>
			<search><![CDATA[<?php echo $footer; ?>]]></search>
      <add position="before">
        <![CDATA[
          <?php if(!empty($data['perpetto']['cart_id']) && $perpetto['enabled']) { ?>
          <div class="ptto-cart" style="display: none">
            <!-- required -->
            <div class="ptto-cart-id"><?php echo $data['perpetto']['cart_id'] ?></div>
            <div class="ptto-total"><?php echo $data['perpetto']['total'] ?></div>
            <div class="ptto-currency"><?php echo $data['perpetto']['currency'] ?></div>

            <?php foreach ($products as $product) { ?>
              <?php $data['perpetto']['product_id'] = $product['product_id']; ?>
                <div class="ptto-item">
                  <div class="ptto-id"><?php echo $data['perpetto']['product_id'] ?></div>
                  <div class="ptto-quantity"><?php echo $product['quantity'] ?></div>
                  <div class="ptto-price"><?php echo $product['original_price'] ?></div>
                  <div class="ptto-itemTotal"><?php echo $product['quantity'] * $product['original_price'] ?></div>
                </div>
              <?php } ?>
            </div>
          <?php } ?>
        ]]>
      </add>
		</operation>

    <operation>
			<search><![CDATA[<?php $tbData->slotStart('checkout/cart.breadcrumbs'); ?>]]></search>
      <add position="after">
        <![CDATA[
          <?php if(!empty($data['perpetto']['cart_id']) && $perpetto['enabled']) { ?>
            <div class="ptto-cart" style="display: none">
            <!-- required -->
            <div class="ptto-cart-id"><?php echo $data['perpetto']['cart_id'] ?></div>
            <div class="ptto-total"><?php echo $data['perpetto']['total'] ?></div>
            <div class="ptto-currency"><?php echo $data['perpetto']['currency'] ?></div>
              <?php foreach ($products as $product) { ?>
                <?php $data['perpetto']['product_id'] = $product['product_id']; ?>
                   <div class="ptto-item">
                     <div class="ptto-id"><?php echo $data['perpetto']['product_id'] ?></div>
                     <div class="ptto-quantity"><?php echo $product['quantity'] ?></div>
                     <div class="ptto-price"><?php echo $product['original_price'] ?></div>
                     <div class="ptto-itemTotal"><?php echo $product['quantity'] * $product['original_price'] ?></div>
                  </div>
                <?php } ?>
            </div>
          <?php } ?>
        ]]>
      </add>
		</operation>
	</file>

  <!-- QUICKCHECKOUT SUPPORT -->
  <file path="catalog/view/theme/*/template/quickcheckout/cart.tpl">
    <operation>
      <search><![CDATA[</tbody>]]></search>
      <add position="before">
        <![CDATA[
          <?php if(!empty($data['perpetto']['cart_id']) && $perpetto['enabled']) { ?>
            <div class="ptto-cart" style="display: none">
              <!-- required -->
              <div class="ptto-cart-id"><?php echo $data['perpetto']['cart_id'] ?></div>
              <div class="ptto-total"><?php echo $data['perpetto']['total'] ?></div>
              <div class="ptto-currency"><?php echo $data['perpetto']['currency'] ?></div>
              <?php foreach ($products as $product) { ?>
                <?php $data['perpetto']['product_id'] = $product['product_id']; ?>
                 <div class="ptto-item">
                   <div class="ptto-id"><?php echo $data['perpetto']['product_id'] ?></div>
                   <div class="ptto-quantity"><?php echo $product['quantity'] ?></div>
                   <div class="ptto-price"><?php echo $product['original_price'] ?></div>
                   <div class="ptto-itemTotal"><?php echo $product['quantity'] * $product['original_price'] ?></div>
                </div>
              <?php } ?>
            </div>
          <?php } ?>
        ]]>
      </add>
		</operation>
	</file>

  <!-- AJAXQUICKCHECKOUT SUPPORT -->
  <file path="catalog/view/theme/*/template/d_quickcheckout/cart.tpl">
    <operation>
      <search><![CDATA[</tbody>]]></search>
      <add position="before">
        <![CDATA[
          <?php if(!empty($data['perpetto']['cart_id']) && $perpetto['enabled']) { ?>
            <div class="ptto-cart" style="display: none">
              <!-- required -->
              <div class="ptto-cart-id"><?php echo $data['perpetto']['cart_id'] ?></div>
              <div class="ptto-total"><?php echo $data['perpetto']['total'] ?></div>
              <div class="ptto-currency"><?php echo $data['perpetto']['currency'] ?></div>

              <?php foreach ($products as $product) { ?>
                <?php $data['perpetto']['product_id'] = $product['product_id']; ?>
                  <div class="ptto-item">
                    <div class="ptto-id"><?php echo $data['perpetto']['product_id'] ?></div>
                    <div class="ptto-quantity"><?php echo $product['quantity'] ?></div>
                    <div class="ptto-price"><?php echo $product['original_price'] ?></div>
                    <div class="ptto-itemTotal"><?php echo $product['quantity'] * $product['original_price'] ?></div>
                  </div>
              <?php } ?>
            </div>
          <?php } ?>
        ]]>
      </add>
		</operation>
	</file>

  <!-- SIMPLECHECKOUT SUPPORT -->
  <file path="catalog/view/theme/*/template/checkout/simplecheckout_cart.tpl">
    <operation>
      <search><![CDATA[<?php if (isset($modules['voucher'])) { ?>]]></search>
      <add position="before">
        <![CDATA[
        <?php if(!empty($data['perpetto']['cart_id']) && $perpetto['enabled']) { ?>
          <div class="ptto-cart" style="display: none">
            <!-- required -->
            <div class="ptto-cart-id"><?php echo $data['perpetto']['cart_id'] ?></div>
            <div class="ptto-total"><?php echo $data['perpetto']['total'] ?></div>
            <div class="ptto-currency"><?php echo $data['perpetto']['currency'] ?></div>

            <?php foreach ($products as $product) { ?>
              <?php $data['perpetto']['product_id'] = $product['product_id']; ?>
                <div class="ptto-item">
                <div class="ptto-id"><?php echo $data['perpetto']['product_id'] ?></div>
                <div class="ptto-quantity"><?php echo $product['quantity'] ?></div>
                <div class="ptto-price"><?php echo $product['original_price'] ?></div>
                <div class="ptto-itemTotal"><?php echo $product['quantity'] * $product['original_price'] ?></div>
              </div>
            <?php } ?>
          </div>
        <?php } ?>
        ]]>
      </add>
		</operation>
	</file>

  <file path="catalog/controller/common/cart.php">
    <operation>
			<search><![CDATA[$data['products'][] = array(]]></search>
      <add position="after">
        <![CDATA[
          'product_id'   => $product['product_id'],
          'original_price' => $this->tax->calculate($product['price'], $product['tax_class_id'], $this->config->get('config_tax')),
        ]]>
      </add>
		</operation>

		<operation>
			<search><![CDATA[if (file_exists(DIR_TEMPLATE . $this->config->get('config_template') . '/template/common/cart.tpl')) {]]></search>
      <add position="before">
        <![CDATA[
          if(isset($this->session->data['perpetto_cart_id'])) {
            $data['perpetto']['cart_id'] = $this->session->data['perpetto_cart_id'];
          } else {
            $data['perpetto']['cart_id'] = '';
          }

          if(!empty($total_data)) {
            foreach($total_data as $p_data) {
              if($p_data['code'] == 'total') {
                $data['perpetto']['total'] = $p_data['value'];
              }
            }
          } else {
            $data['perpetto']['total'] = 0;
          }

          $data['perpetto']['currency'] =  $this->session->data['currency'];

          if(empty($data['products']) || count($data['products']) < 1) {
            $data['perpetto']['enabled'] = false;
          } else {
            $data['perpetto']['enabled'] = true;
          }
        ]]>
      </add>
		</operation>
	</file>

  <file path="catalog/view/theme/*/template/common/cart.tpl">
		<operation>
			<search><![CDATA[<div id="cart"]]></search>
      <add position="before">
        <![CDATA[
          <?php if(!empty($data['perpetto']['cart_id']) && $perpetto['enabled']) { ?>
            <div class="ptto-cart" style="display: none">
              <!-- required -->
              <div class="ptto-cart-id"><?php echo $data['perpetto']['cart_id'] ?></div>
              <div class="ptto-total"><?php echo $data['perpetto']['total'] ?></div>
              <div class="ptto-currency"><?php echo $data['perpetto']['currency'] ?></div>

              <?php foreach ($products as $product) { ?>
                <?php $data['perpetto']['product_id'] = $product['product_id']; ?>
                <div class="ptto-item">
                  <div class="ptto-id"><?php echo $data['perpetto']['product_id'] ?></div>
                  <div class="ptto-quantity"><?php echo $product['quantity'] ?></div>
                  <div class="ptto-price"><?php echo $product['original_price'] ?></div>
                  <div class="ptto-itemTotal"><?php echo $product['quantity'] * $product['original_price'] ?></div>
                </div>
              <?php } ?>
            </div>
            <script>
              $(document).ready(function() {
                Perpetto.update();
              });
            </script>
          <?php } ?>
        ]]>
      </add>
		</operation>
  </file>

  <file path="catalog/controller/account/success.php">
    <operation>
      <search><![CDATA[$this->load->model('account/customer_group');]]></search>
      <add position="after">
        <![CDATA[
          $customer_info = $this->model_account_customer->getCustomer($this->customer->getId());

          $this->data['email'] = $customer_info['email'];
          $this->data['firstname'] = $customer_info['firstname'];
          $this->data['lastname'] = $customer_info['lastname'];
        ]]>
      </add>
    </operation>
  </file>

  <file path="catalog/controller/checkout/success.php">
    <operation>
      <search>
        <![CDATA[public function index() {]]>
      </search>
      <add position="after">
        <![CDATA[
          if(isset($this->session->data['perpetto_cart_id'])) {
            $data['perpetto']['cart_id'] = $this->session->data['perpetto_cart_id'];
            unset($this->session->data['perpetto_cart_id']);
          } else {
            $data['perpetto']['cart_id'] = '';
          }

          if ($this->customer->isLogged()) {

            $data['email'] = $this->customer->getEmail();
            $data['firstname'] = $this->customer->getFirstname();
            $data['lastname'] = $this->customer->getLastname();

          } elseif(!empty($this->session->data['order_id']) ) {

            $this->load->model('checkout/order');
            $order = $this->model_checkout_order->getOrder($this->session->data['order_id']);
            $data['firstname'] = $order['firstname'];
            $data['lastname'] = $order['lastname'];
            $data['email'] = $order['email'];
          }
        ]]>
      </add>
		</operation>
	</file>

  <file path="catalog/view/theme/*/template/common/header.tpl">
		<operation>
      <search regex="true" limit="1"><![CDATA[([\s\S]*)]]></search>
      <add>
        <![CDATA[
          $0
          <?php if($this->customer->getId() != NULL) { ?>
            <div class="ptto-user-details" style="display: none;">
              <div class="ptto-email"><?php echo $this->customer->getEmail() ?></div>
              <div class="ptto-firstname"><?php echo $this->customer->getFirstName() ?></div>
              <div class="ptto-lastname"><?php echo $this->customer->getLastName() ?></div>
            </div>
          <?php }?>
        ]]>
      </add>
		</operation>
	</file>

  <file path="catalog/view/theme/*/template/common/success.tpl">
		<operation>
			<search><![CDATA[<?php echo $footer; ?>]]></search>
      <add position="before">
        <![CDATA[
          <div class="ptto-cart-paid" style="display: none">
            <div class="ptto-cart-id"><?php echo $perpetto['cart_id'] ?></div>
          </div>
          <?php if($_GET['route'] == 'account/success' || $_GET['route'] == 'checkout/success') { ?>
            <div class="ptto-user-details" style="display: none;">
              <div class="ptto-email"><?php echo $email ?></div>
              <div class="ptto-firstname"><?php echo $firstname?></div>
              <div class="ptto-lastname"><?php echo $lastname?></div>
            </div>
          <?php } ?>
        ]]>
      </add>
		</operation>
    <operation>
			<search><![CDATA[<?php $tbData->slotStartSystem('common/success.breadcrumbs'); ?>]]></search>
      <add position="after">
        <![CDATA[
          <div class="ptto-cart-paid" style="display: none">
            <div class="ptto-cart-id"><?php echo $perpetto['cart_id'] ?></div>
          </div>
          <?php if($_GET['route'] == 'account/success' || $_GET['route'] == 'checkout/success') { ?>
            <div class="ptto-user-details" style="display: none;">
              <div class="ptto-email"><?php echo $email ?></div>
              <div class="ptto-firstname"><?php echo $firstname?></div>
              <div class="ptto-lastname"><?php echo $lastname?></div>
            </div>
          <?php } ?>
        ]]>
      </add>
		</operation>
	</file>

  <file path="catalog/controller/common/content_top.php">
		<operation>
			<search><![CDATA[$part = explode('.', $module['code']);]]></search>
      <add position="after">
        <![CDATA[
          if($module['code'] == 'perpetto') {
            $GLOBALS['ptto_current_position'] = 'content_top';
          }
        ]]>
      </add>
		</operation>
	</file>

  <file path="catalog/controller/common/content_bottom.php">
		<operation>
			<search><![CDATA[$part = explode('.', $module['code']);]]></search>
      <add position="after">
        <![CDATA[
          if($module['code'] == 'perpetto') {
            $GLOBALS['ptto_current_position'] = 'content_bottom';
          }
        ]]>
      </add>
		</operation>
	</file>

  <file path="catalog/controller/common/column_left.php">
		<operation>
			<search><![CDATA[$part = explode('.', $module['code']);]]></search>
      <add position="after">
        <![CDATA[
				if($module['code'] == 'perpetto') {
          $GLOBALS['ptto_current_position'] = 'column_left';
        }
        ]]>
      </add>
		</operation>
	</file>

  <file path="catalog/controller/common/column_right.php">
		<operation>
			<search><![CDATA[$part = explode('.', $module['code']);]]></search>
      <add position="after">
        <![CDATA[
				  if($module['code'] == 'perpetto') {
            $GLOBALS['ptto_current_position'] = 'column_right';
          }
        ]]>
      </add>
		</operation>
	</file>

  <file path="admin/view/template/design/layout_form.tpl">

    <operation>
      <search><![CDATA[<option value="<?php echo $extension['code']; ?>"><?php echo addslashes($extension['name']); ?></option>]]></search>
      <add position="replace"><![CDATA[<option <?php if($extension['code'] == 'perpetto') echo 'disabled="disabled"' ?> value="<?php echo $extension['code']; ?>"><?php echo addslashes($extension['name']); ?></option>]]></add>
    </operation>

    <operation>
      <search><![CDATA[<option value="<?php echo $extension['code']; ?>"><?php echo $extension['name']; ?></option>]]></search>
      <add position="replace"><![CDATA[<option <?php if($extension['code'] == 'perpetto') echo 'disabled="disabled"' ?> value="<?php echo $extension['code']; ?>"><?php echo $extension['name']; ?></option>]]></add>
    </operation>

    <operation>
      <search><![CDATA[<select name="layout_module[<?php echo $module_row; ?>][code]" class="form-control">]]></search>
      <add position="replace"><![CDATA[<input type="hidden" name="layout_module[<?php echo $module_row; ?>][code]" value="perpetto" /><select name="layout_module[<?php echo $module_row; ?>][code]" <?php if($layout_module['code'] == 'perpetto') echo 'disabled="disabled"'; ?> class="form-control">]]></add>
    </operation>

    <operation>
      <search><![CDATA[<select name="layout_module[<?php echo $module_row; ?>][position]" class="form-control">]]></search>
      <add position="replace"><![CDATA[<input type="hidden" name="layout_module[<?php echo $module_row; ?>][position]" value="<?php echo $layout_module['position'] ?>" /><select name="layout_module[<?php echo $module_row; ?>][position]" <?php if($layout_module['code'] == 'perpetto') echo 'disabled="disabled"'; ?> class="form-control">]]></add>
    </operation>

    <operation>
      <search><![CDATA[<input type="text" name="layout_module[<?php echo $module_row; ?>][sort_order]" value="<?php echo $layout_module['sort_order']; ?>" placeholder="<?php echo $entry_sort_order; ?>" class="form-control" />]]></search>
      <add position="replace"><![CDATA[<input type="hidden" name="layout_module[<?php echo $module_row; ?>][sort_order]" value="<?php echo $layout_module['sort_order']; ?>" /><input type="text" name="layout_module[<?php echo $module_row; ?>][sort_order]" value="<?php echo $layout_module['sort_order']; ?>" placeholder="<?php echo $entry_sort_order; ?>" <?php if($layout_module['code'] == 'perpetto') echo 'disabled="disabled"'; ?> class="form-control" />]]></add>
    </operation>

    <operation>
      <search><![CDATA[<button type="button" onclick="$('#module-row<?php echo $module_row; ?>').remove();" data-toggle="tooltip" title="<?php echo $button_remove; ?>" class="btn btn-danger"><i class="fa fa-minus-circle"></i></button>]]></search>
      <add position="replace"><![CDATA[<button type="button" onclick="$('#module-row<?php echo $module_row; ?>').remove();" data-toggle="tooltip" title="<?php echo $button_remove; ?>" <?php if($layout_module['code'] == 'perpetto') echo 'disabled="disabled"'; ?> class="btn btn-danger"><i class="fa fa-minus-circle"></i></button>]]></add>
    </operation>

    <operation>
      <search><![CDATA[<?php echo $footer; ?>]]></search>
      <add position="before">
        <![CDATA[
          <script>
            $(document).ready(function() {
              $('tr:has(select:disabled)').attr('data-popover-content','Go to Perpetto\'s admin panel');
              $('tr:has(select:disabled)').attr('data-popover-url','index.php?route=module/perpetto&token=<?php echo $_SESSION["token"] ?>');

              var options = {placement: 'bottom', trigger: 'manual', html: true};

              function createPopover(element, args){
                  var href =  $(element).data('popover-url'), txt = $(element).data('popover-content');
                  var html = '<p>This position is managed from Perpetto extension Admin Panel</p><p><a href="'+href+'">'+txt+'</a></p>';

                  $(element).data('content', html).popover(args);
              }

              function popoverPlacementBottom(){
                  createPopover($(this), options);
              }

              $('tr:has(select:disabled)').each(popoverPlacementBottom);
              var insidePopover=false;

              function attachEvents(tr) {
                $('.popover').on('mouseenter', function() {
                  insidePopover=true;
                });
                $('.popover').on('mouseleave', function() {
                  insidePopover=false;
                  $(tr).popover('hide');
                });
              }

              $('table').on('mouseenter', 'tr:has(select:disabled)', function() {
                var tr=$(this);
                setTimeout(function() {
                  if (!insidePopover) {
                    $(tr).popover('show');
                    attachEvents(tr);
                  }
                }, 200);
              });

              $('table').on('mouseleave', 'tr:has(select:disabled)', function() {
                var tr=$(this);
                setTimeout(function() {
                  if (!insidePopover) $(tr).popover('hide');
                }, 200);
              });

            });
          </script>
        ]]>
      </add>
		</operation>
	</file>

  <!-- VERSION 2 -->
  <file path="catalog/controller/account/account.php">
    <operation>
      <search><![CDATA[if (file_exists(DIR_TEMPLATE . $this->config->get('config_template') . '/template/account/account.tpl')) {]]></search>
      <add position="before">
        <![CDATA[
          $data['email'] = $this->customer->getEmail();
          $data['firstname'] = $this->customer->getFirstname();
          $data['lastname'] = $this->customer->getLastname();
        ]]>
      </add>
    </operation>
  </file>

  <file path="catalog/view/theme/*/template/account/edit.tpl">
    <operation>
      <search><![CDATA[<?php echo $header; ?>]]></search>
      <add position="after">
        <![CDATA[
          <div style="display: none;" class="ptto-user-details">
            <div class="ptto-email"><?php echo $email ?></div>
            <div class="ptto-firstname"><?php echo $firstname?></div>
            <div class="ptto-lastname"><?php echo $lastname?></div>
          </div>
        ]]>
      </add>
    </operation>
  </file>

  <file path="catalog/view/theme/*/template/account/account.tpl">
    <operation>
      <search><![CDATA[<?php echo $header; ?>]]></search>
      <add position="after">
        <![CDATA[
          <div style="display: none;" class="ptto-user-details">
            <div class="ptto-email"><?php echo $email ?></div>
            <div class="ptto-firstname"><?php echo $firstname?></div>
            <div class="ptto-lastname"><?php echo $lastname?></div>
          </div>
        ]]>
      </add>
    </operation>
  </file>
</modification>
